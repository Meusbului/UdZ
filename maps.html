<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maps - myGW</title>
    <!-- Use Inter font to match index page branding -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="screen">
    <header class="top" style="position:relative;z-index:20">
      <div class="top-inner">
        <div class="brand">
          <div class="brand-text">
            <a href="index.html" class="brand-link">
              <div class="brand-title">myGW</div>
              <div class="brand-sub">WE MOVE FOR YOU</div>
            </a>
          </div>
        </div>
        <a href="index.html" class="header-badge-link" aria-label="Back to home"><span class="badge placeholder-orange" aria-hidden="true"></span></a>
      </div>
    </header>

    <!-- Fullscreen interactive map (Leaflet) - header stays above -->
    <div id="map" style="position:fixed;inset:0;z-index:0"></div>
    <!-- Locate control: positioned bottom-right above the status toast; pushed further down -->
    <div id="locateControl" style="position:fixed;right:12px;bottom:56px;z-index:30;bottom:calc(56px + env(safe-area-inset-bottom));">
      <button id="locateBtn" style="background:#ff6a00;color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:600;box-shadow:0 6px 18px rgba(0,0,0,0.12);">Locate</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        // Center roughly where the previous bbox was (lat, lon)
        var centerLat = 47.55, centerLon = 9.725;
  var map = L.map('map', {zoomControl:false, attributionControl:false}).setView([centerLat, centerLon], 11);

        // Dark tiles (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19,
          detectRetina: false,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; CARTO'
        }).addTo(map);

        // Minor CSS tweak to reduce visible tile seams on some mobile browsers
        var style = document.createElement('style');
        style.innerHTML = '\n          .leaflet-tile { background-color: #111; image-rendering: -webkit-optimize-contrast; }\n          .leaflet-tile-loaded { opacity: 1; }\n        ';
        document.head.appendChild(style);

        // ensure header sits above the map
        var header = document.querySelector('.top');
        if(header) header.style.zIndex = 20;

        // Live user location marker (uses browser Geolocation API)
        var userMarker = null;
        var accuracyCircle = null;
  // bottom-right toast for location status
  var statusEl = document.createElement('div');
  statusEl.className = 'location-toast';
  statusEl.style.cssText = 'position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;z-index:9999';
  statusEl.textContent = '';
  document.body.appendChild(statusEl);

        var watchId = null;
        var locateBtn = document.getElementById('locateBtn');
        function isInAppBrowser(){
          // simple heuristic for in-app browsers
          var ua = navigator.userAgent || '';
          return (/FBAN|FBAV|Instagram|Line|KAKAOTALK|WhatsApp/i).test(ua);
        }

        function startWatching(){
          if(!navigator.geolocation){
            statusEl.textContent = 'Geolocation unsupported';
            return;
          }
          statusEl.textContent = 'Requesting location...';
          // request watchPosition on user gesture
          watchId = navigator.geolocation.watchPosition(function(pos){
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            var acc = pos.coords.accuracy || 0;
            // add or update marker
            if(!userMarker){
              userMarker = L.circleMarker([lat,lon], {radius:8, color:'#ff6a00', fillColor:'#ff6a00', fillOpacity:1, weight:2}).addTo(map);
            }else{
              userMarker.setLatLng([lat,lon]);
            }
            if(!accuracyCircle){
              accuracyCircle = L.circle([lat,lon], {radius: acc, color:'#ff6a00', weight:1, fillColor:'#ff6a00', fillOpacity:0.08}).addTo(map);
            }else{
              accuracyCircle.setLatLng([lat,lon]);
              accuracyCircle.setRadius(acc);
            }
            statusEl.textContent = 'Location updated';
            // briefly highlight the toast
            statusEl.style.background = 'rgba(255,106,0,0.95)';
            setTimeout(()=>{ statusEl.style.background = 'rgba(0,0,0,0.6)'; }, 900);
            // pan map to user on first fix
            if(map && !map._userCentered){ map.setView([lat,lon], 16); map._userCentered = true; }
          }, function(err){
            // map common error codes
            if(err && err.code === 1){
              statusEl.textContent = 'Permission denied. Open this page in Safari and allow location.';
            }else if(err && err.code === 3){
              statusEl.textContent = 'Location request timed out.';
            }else{
              statusEl.textContent = 'Location unavailable';
            }
          }, {enableHighAccuracy:true, maximumAge:3000, timeout:10000});
          locateBtn.textContent = 'Stop';
        }

        function stopWatching(){
          if(watchId !== null){
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
          // remove markers from the map so the dot disappears
          if(userMarker){ map.removeLayer(userMarker); userMarker = null; }
          if(accuracyCircle){ map.removeLayer(accuracyCircle); accuracyCircle = null; }
          if(map && map._userCentered){ delete map._userCentered; }
          statusEl.textContent = 'Location stopped';
          locateBtn.textContent = 'Locate';
        }

        if(locateBtn){
          locateBtn.addEventListener('click', function(){
            // heuristic: in-app browsers often block permissions; warn user
            if(isInAppBrowser()){
              statusEl.textContent = 'If permission fails, open this page in Safari for best results.';
            }
            if(watchId === null) startWatching(); else stopWatching();
          });
        }
      });
    </script>
  </div>
</body>
</html>